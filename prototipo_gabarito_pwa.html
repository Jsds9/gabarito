<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Protótipo: Corretor de Gabaritos (PWA)</title>
  <meta name="description" content="Protótipo web (PWA) que usa a câmera para corrigir gabaritos por detecção de bolinhas.">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#06b6d4}
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial,Helvetica,sans-serif}
    body{margin:0;background:linear-gradient(180deg,#071226 0%, #071830 100%);color:#e6eef6;min-height:100vh;display:flex;gap:18px;align-items:flex-start;padding:18px}
    .app{max-width:1100px;margin:0 auto;width:100%}
    header{display:flex;align-items:center;gap:12px}
    h1{margin:0;font-size:18px}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
    .card{background:rgba(255,255,255,0.03);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    video, canvas{width:100%;border-radius:8px;background:#000}
    label{display:block;margin-top:8px;color:var(--muted);font-size:13px}
    input, select, button, textarea{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .row{display:flex;gap:8px}
    .small{width:70px}
    .result{padding:8px;border-radius:8px;margin-top:8px;background:rgba(6,182,212,0.06);color:var(--accent)}
    .overlay{position:relative}
    .overlay canvas{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}
    footer{margin-top:12px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Protótipo: Corretor de Gabaritos (PWA)</h1>
    </header>
    <main class="grid">
      <section class="card">
        <h3>1) Câmera / Captura</h3>
        <div class="overlay">
          <video id="camera" playsinline autoplay></video>
          <canvas id="overlayCanvas"></canvas>
        </div>
        <div style="margin-top:8px" class="row">
          <button id="startCam">Iniciar câmera</button>
          <button id="capture">Capturar</button>
          <button id="process">Processar</button>
        </div>

        <h3 style="margin-top:12px">2) Parâmetros do gabarito</h3>
        <label>Nº de questões</label>
        <input id="numQ" type="number" value="10" min="1">
        <label>Alternativas por questão (ex: 4 = A–D, 5 = A–E)</label>
        <input id="numAlt" type="number" value="4" min="2" max="6">
        <label>Linhas de leitura (quantas linhas de questões no papel)</label>
        <input id="numLines" type="number" value="5" min="1">

        <label>Gabarito correto (seq. ex: A,B,C,D,...)</label>
        <input id="answerKey" placeholder="Ex: A,B,C,D,A,B,C,D,A,B" value="A,B,C,D,A,B,C,D,A,B">

        <div class="row" style="margin-top:8px">
          <button id="loadKey">Carregar gabarito</button>
          <button id="exportJSON">Exportar gabarito (JSON)</button>
        </div>

        <h3 style="margin-top:12px">3) Resultado</h3>
        <div id="resultBox" class="result">Nenhuma análise realizada ainda.</div>

        <footer>
          Use este protótipo em celular apontando para um gabarito impresso. Para melhores resultados, adicione marcadores nos cantos ou alinhe bem o formulário.
        </footer>
      </section>

      <section class="card">
        <h3>Visão e Processamento</h3>
        <canvas id="canvasOut"></canvas>
        <h4>Log</h4>
        <textarea id="log" rows="8" readonly></textarea>
      </section>
    </main>
  </div>

  <!-- OpenCV.js -->
  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
  <script>
    const video = document.getElementById('camera');
    const overlayCanvas = document.getElementById('overlayCanvas');
    const canvasOut = document.getElementById('canvasOut');
    const startCamBtn = document.getElementById('startCam');
    const captureBtn = document.getElementById('capture');
    const processBtn = document.getElementById('process');
    const numQ = document.getElementById('numQ');
    const numAlt = document.getElementById('numAlt');
    const numLines = document.getElementById('numLines');
    const answerKey = document.getElementById('answerKey');
    const loadKeyBtn = document.getElementById('loadKey');
    const exportBtn = document.getElementById('exportJSON');
    const logEl = document.getElementById('log');
    const resultBox = document.getElementById('resultBox');

    let stream = null;
    let capturedImage = null;
    let cvReady = false;

    function log(s){
      logEl.value = (new Date()).toLocaleTimeString()+" — "+s+"\n"+logEl.value;
    }

    async function startCamera(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' } },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        overlayCanvas.width = video.videoWidth;
        overlayCanvas.height = video.videoHeight;
        canvasOut.width = 800;
        canvasOut.height = 1100;
        log('Câmera iniciada');
      }catch(e){
        log('Erro ao iniciar câmera: '+e.message);
        alert('Não foi possível acessar a câmera: '+e.message);
      }
    }

    startCamBtn.addEventListener('click', ()=>startCamera());

    captureBtn.addEventListener('click', ()=>{
      if(!video || video.readyState!==4){ alert('Câmera não pronta'); return; }
      const cvCanvas = document.createElement('canvas');
      cvCanvas.width = video.videoWidth;
      cvCanvas.height = video.videoHeight;
      const ctx = cvCanvas.getContext('2d');
      ctx.drawImage(video,0,0,cvCanvas.width,cvCanvas.height);
      capturedImage = new Image();
      capturedImage.src = cvCanvas.toDataURL('image/png');
      capturedImage.onload = ()=>{
        const ctxOut = canvasOut.getContext('2d');
        ctxOut.clearRect(0,0,canvasOut.width,canvasOut.height);
        const scale = Math.min(canvasOut.width/capturedImage.width, canvasOut.height/capturedImage.height);
        const w = capturedImage.width*scale, h = capturedImage.height*scale;
        ctxOut.drawImage(capturedImage,0,0,w,h);
        log('Imagem capturada e carregada para processamento');
      }
    });

    function parseAnswerKey(text){ return text.split(',').map(s=>s.trim().toUpperCase()).filter(Boolean); }

    loadKeyBtn.addEventListener('click', ()=>{
      const arr = parseAnswerKey(answerKey.value);
      if(arr.length!=Number(numQ.value)){
        if(!confirm('O número de respostas fornecidas ('+arr.length+') não bate com Nº de questões ('+numQ.value+'). Continuar?')) return;
      }
      log('Gabarito carregado: '+arr.join(','));
      resultBox.textContent = 'Gabarito carregado — pronto para análise.';
    });

    exportBtn.addEventListener('click', ()=>{
      const data = {numQ:Number(numQ.value), numAlt:Number(numAlt.value), key:parseAnswerKey(answerKey.value)};
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'gabarito.json'; a.click();
      URL.revokeObjectURL(url);
      log('Gabarito exportado (JSON)');
    });

    processBtn.addEventListener('click', ()=>{
      if(!capturedImage){ alert('Capture uma imagem primeiro.'); return; }
      if(!cvReady){ alert('OpenCV ainda não carregado. Aguarde.'); return; }
      processImage();
    });

    function onOpenCvReady(){
      cv['onRuntimeInitialized']=()=>{
        cvReady = true; log('OpenCV pronto');
      }
    }

    // O restante do código do processamento e análise de bolinhas permanece igual ao protótipo original.
    // ...
  </script>
</body>
</html>
