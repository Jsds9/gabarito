<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Corretor de Gabaritos - Overlay em tempo real</title>
<style>
body{font-family:sans-serif;background:#071226;color:#fff;display:flex;flex-direction:column;align-items:center;padding:12px}
#cameraWrapper{position:relative;display:inline-block}
video, canvas{border:1px solid #333;border-radius:8px;max-width:100%}
#overlay{position:absolute;left:0;top:0;pointer-events:none}
input, button{margin:6px 0;padding:8px 12px;border-radius:6px;border:none;font-size:16px}
button{background:#0ea5e9;color:#fff;cursor:pointer}
.result{margin-top:12px;padding:8px;background:rgba(6,182,212,0.1);border-radius:6px;white-space:pre-line}
</style>
</head>
<body>
<h1>Corretor de Gabaritos</h1>

<div id="cameraWrapper">
  <video id="camera" autoplay playsinline></video>
  <canvas id="overlay"></canvas>
</div><br>

<button id="captureBtn">üì∏ Capturar</button>
<button id="processBtn">‚ö° Processar</button><br>

<label>Gabarito correto (ex: A,B,C,D,E,A,B...)</label>
<input id="answerKey" placeholder="Ex: A,B,C,D,E,A,B" value="A,B,C,D,E,A,B,C,D,E">

<canvas id="canvasOut" width="400" height="500"></canvas>

<div class="result" id="resultBox">Nenhuma an√°lise realizada.</div>

<script>
const video=document.getElementById('camera');
const overlay=document.getElementById('overlay');
const octx=overlay.getContext('2d');
const canvas=document.getElementById('canvasOut');
const ctx=canvas.getContext('2d');
const captureBtn=document.getElementById('captureBtn');
const processBtn=document.getElementById('processBtn');
const resultBox=document.getElementById('resultBox');

let capturedImage=null;

async function startCamera(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    video.srcObject=stream;
    await video.play();

    // Ajusta overlay do mesmo tamanho do v√≠deo
    overlay.width=video.videoWidth;
    overlay.height=video.videoHeight;

    drawLiveGrid();
  }catch(e){alert('Erro ao acessar c√¢mera: '+e.message);}
}
startCamera();

// Desenha grid em loop
function drawLiveGrid(){
  requestAnimationFrame(drawLiveGrid);
  if(!overlay.width||!overlay.height) return;

  octx.clearRect(0,0,overlay.width,overlay.height);

  const numQuestions=document.getElementById('answerKey').value.split(',').length;
  const numOptions=5;
  const qHeight=overlay.height/numQuestions;
  const oWidth=overlay.width/numOptions;

  octx.strokeStyle='rgba(255,255,255,0.6)';
  octx.lineWidth=1;

  for(let i=1;i<numQuestions;i++){
    octx.beginPath();
    octx.moveTo(0,i*qHeight);
    octx.lineTo(overlay.width,i*qHeight);
    octx.stroke();
  }
  for(let j=1;j<numOptions;j++){
    octx.beginPath();
    octx.moveTo(j*oWidth,0);
    octx.lineTo(j*oWidth,overlay.height);
    octx.stroke();
  }
}

captureBtn.addEventListener('click',()=>{
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  capturedImage=ctx.getImageData(0,0,canvas.width,canvas.height);
  alert('Foto capturada! Agora clique em Processar.');
});

// Fun√ß√£o de detec√ß√£o simples
function detectFilledBubbles(imgData,numQuestions=10,numOptions=5){
  const results=[];
  const w=imgData.width;
  const h=imgData.height;
  const qHeight=Math.floor(h/numQuestions);
  const oWidth=Math.floor(w/numOptions);
  for(let i=0;i<numQuestions;i++){
    let maxSum=0, sel=0;
    for(let o=0;o<numOptions;o++){
      let sum=0;
      for(let y=i*qHeight;y<(i+1)*qHeight;y++){
        for(let x=o*oWidth;x<(o+1)*oWidth;x++){
          const idx=(y*w+x)*4;
          const r=imgData.data[idx],g=imgData.data[idx+1],b=imgData.data[idx+2];
          const brightness=(r+g+b)/3;
          sum+=255-brightness;
        }
      }
      if(sum>maxSum){maxSum=sum; sel=o;}
    }
    results.push(sel);
  }
  return results;
}

processBtn.addEventListener('click',()=>{
  if(!capturedImage){alert('Capture uma foto antes.'); return;}
  const answerText=document.getElementById('answerKey').value;
  const key=answerText.split(',').map(s=>s.trim().toUpperCase());
  const detected=detectFilledBubbles(capturedImage,key.length,5);

  ctx.putImageData(capturedImage,0,0);

  let score=0;
  let feedback='';
  const qHeight=Math.floor(canvas.height/key.length);
  const oWidth=Math.floor(canvas.width/5);
  const letters="ABCDE";

  for(let i=0;i<key.length;i++){
    const correctIdx=letters.indexOf(key[i]);
    const chosen=detected[i];
    const centerX=chosen*oWidth+oWidth/2;
    const centerY=i*qHeight+qHeight/2;

    if(correctIdx===chosen){
      score++;
      ctx.strokeStyle='lime';
    }else{
      ctx.strokeStyle='red';
    }
    ctx.lineWidth=4;
    ctx.beginPath();
    ctx.arc(centerX,centerY,Math.min(oWidth,qHeight)/4,0,2*Math.PI);
    ctx.stroke();

    feedback+=`Q${i+1}: Esperado ${key[i]}, Marcado ${letters[chosen]} ${chosen===correctIdx?'‚úÖ':'‚ùå'}\n`;
  }

  resultBox.textContent=`Acertos: ${score}/${key.length}\n\n${feedback}`;
});
</script>
</body>
</html>
